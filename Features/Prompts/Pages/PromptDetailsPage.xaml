<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.PromptDetailsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:QuickPrompt.Models"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    xmlns:buttons="clr-namespace:QuickPrompt.Components.Buttons"
    x:Name="promptDetailsPage"
    BackgroundColor="{StaticResource SurfaceBackground}"
    Shell.PresentationMode="Animated">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False" />
    </Shell.BackButtonBehavior>

    <Shell.TitleView>
        <views:TitleHeader
            Title="Prompt Designer"
            BackCommand="{Binding MyBackCommand}"
            Glyph="&#xe5e0;"
            ShowBackButton="True" />
    </Shell.TitleView>

    <ContentPage.ToolbarItems>
        <ToolbarItem
            Command="{Binding SharePromptCommand}"
            IsEnabled="{Binding IsShareButtonVisible}"
            Text="Share">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe80d;"
                    Color="{StaticResource PrimaryBlueDark}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>

        <ToolbarItem
            Command="{Binding NavigateToEditPromptCommand}"
            CommandParameter="{Binding PromptID}"
            Text="Edit">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe3c9;"
                    Color="{StaticResource PrimaryBlueDark}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>

        <ToolbarItem 
            Command="{Binding ClearTextCommand}" 
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe5c9;"
                    Color="{StaticResource PrimaryRed}" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>
                Click to Clear Text
            </ToolTipProperties.Text>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout
            Padding="16,16,16,32"
            Spacing="20">

            <!--  Overlay de carga  -->
            <views:ReusableLoadingOverlay
                x:Name="LoadingOverlay"
                IsVisible="{Binding IsLoading}"
                Message="Loading..." />

            <!--  Header Card  -->
            <Border 
                BackgroundColor="{StaticResource CardBackground}"
                StrokeThickness="0"
                Padding="16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="{StaticResource AppBlack}" Opacity="0.15" Radius="12" Offset="0,4" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="8">
                    
                    <!--  TÃ­tulo Principal  -->
                    <Label
                        Style="{StaticResource Heading1TextStyle}"
                        Text="{Binding PromptTitle}"
                        TextColor="{StaticResource PrimaryBlueDark}"
                        HorizontalTextAlignment="Center" />

                    <!--  CategorÃ­a Badge  -->
                    <Border
                        BackgroundColor="{StaticResource PrimaryYellow}"
                        HorizontalOptions="Center"
                        Padding="8,4"
                        StrokeThickness="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="16" />
                        </Border.StrokeShape>
                        
                        <Label
                            FontAttributes="Bold"
                            Style="{StaticResource CaptionTextStyle}"
                            Text="{Binding Category, Converter={StaticResource CategoryToDisplayNameConverter}}"
                            TextColor="{StaticResource White}" />
                    </Border>

                    <!--  DescripciÃ³n  -->
                    <Label
                        Style="{StaticResource BodyTextStyle}"
                        Text="{Binding Description}"
                        TextColor="{StaticResource TextSecondary}"
                        HorizontalTextAlignment="Center"
                        Margin="0,8,0,0" />

                </VerticalStackLayout>
            </Border>

            <!--  Prompt Template Card  -->
            <Border 
                BackgroundColor="{StaticResource CardBackground}"
                StrokeThickness="0"
                Padding="16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="{StaticResource AppBlack}" Opacity="0.15" Radius="12" Offset="0,4" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="12">
                    
                    <Label
                        Style="{StaticResource Heading3TextStyle}"
                        Text="ðŸ“ Prompt Template"
                        TextColor="{StaticResource PrimaryBlueDark}" />

                    <Border
                        BackgroundColor="{StaticResource Info50}"
                        Stroke="{StaticResource Info200}"
                        StrokeThickness="1"
                        Padding="8">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="4" />
                        </Border.StrokeShape>

                        <Label
                            Style="{StaticResource BodyTextStyle}"
                            Text="{Binding PromptText}"
                            TextColor="{StaticResource Info700}" />
                    </Border>

                </VerticalStackLayout>
            </Border>

            <!--  Variables Card  -->
            <Border 
                BackgroundColor="{StaticResource CardBackground}"
                StrokeThickness="0"
                Padding="16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="{StaticResource AppBlack}" Opacity="0.15" Radius="12" Offset="0,4" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="12">
                    
                    <Label
                        Style="{StaticResource Heading3TextStyle}"
                        Text="âœï¸ Complete the Variables"
                        TextColor="{StaticResource PrimaryBlueDark}" />

                    <CollectionView
                        x:Name="VariablesCollection"
                        ItemsSource="{Binding Variables}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <VerticalStackLayout 
                                    Padding="4" 
                                    Spacing="4">

                                    <Label
                                        FontAttributes="Bold"
                                        Style="{StaticResource BodySmallTextStyle}"
                                        Text="{Binding Name}"
                                        TextColor="{StaticResource TextPrimary}" />

                                    <Border Style="{StaticResource InputBorderStyle}">
                                        <Entry
                                            Focused="OnEntryFocused"
                                            Placeholder="Enter value here..."
                                            Style="{StaticResource VariableInputEntryStyle}"
                                            Text="{Binding Value}"
                                            Unfocused="OnEntryUnfocused">
                                            <Entry.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnEntryTapped" />
                                            </Entry.GestureRecognizers>
                                        </Entry>
                                    </Border>

                                    <!--  Sugerencias desde cachÃ©  -->
                                    <CollectionView
                                        Margin="0,4,0,8"
                                        IsVisible="{Binding ShowSuggestions}"
                                        ItemsLayout="HorizontalList"
                                        ItemsSource="{Binding Suggestions}"
                                        SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border 
                                                    Style="{StaticResource SuggestionChipBorderStyle}"
                                                    Margin="4,0">
                                                    <Label
                                                        Style="{StaticResource SuggestionChipLabelStyle}"
                                                        Text="{Binding .}"
                                                        TextColor="{StaticResource TextSecondary}">
                                                        <Label.GestureRecognizers>
                                                            <TapGestureRecognizer 
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type models:VariableInput}}, Path=ApplySuggestionCommand}" 
                                                                CommandParameter="{Binding .}" />
                                                        </Label.GestureRecognizers>
                                                    </Label>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </VerticalStackLayout>
            </Border>

            <!--  Generate Button  -->
            <buttons:PrimaryButton
                Command="{Binding GeneratePromptCommand}"
                Text="Generate Prompt">
                <buttons:PrimaryButton.ImageSource>
                    <FontImageSource
                        FontFamily="MaterialIconsOutlined-Regular"
                        Glyph="&#xe26c;"
                        Color="{StaticResource White}" />
                </buttons:PrimaryButton.ImageSource>
            </buttons:PrimaryButton>

            <!--  Generated Prompt Result  -->
            <Border
                BackgroundColor="{StaticResource CardBackground}"
                Stroke="{StaticResource BorderLight}"
                StrokeThickness="1"
                Padding="16"
                IsVisible="{Binding FinalPrompt, Converter={StaticResource FinalPromptVisibilityConverter}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                
                <VerticalStackLayout Spacing="8">
                    
                    <Label
                        Style="{StaticResource Heading3TextStyle}"
                        Text="âœ¨ Generated Prompt"
                        TextColor="{StaticResource SuccessColor}" />

                    <Label
                        Style="{StaticResource BodyTextStyle}"
                        Text="{Binding FinalPrompt}"
                        TextColor="{StaticResource TextPrimary}"
                        LineBreakMode="WordWrap" />

                </VerticalStackLayout>
            </Border>

            <!--  AI Providers Card  -->
            <Border
                BackgroundColor="{StaticResource CardBackground}"
                StrokeThickness="0"
                Padding="16"
                IsVisible="{Binding ShowPromptActions}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="{StaticResource AppBlack}" Opacity="0.15" Radius="12" Offset="0,4" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="12">
                    
                    <Label
                        Style="{StaticResource Heading3TextStyle}"
                        Text="ðŸ¤– Select an AI Provider"
                        TextColor="{StaticResource PrimaryBlueDark}"
                        HorizontalTextAlignment="Center" />

                    <!--  AI Buttons Grid  -->
                    <Grid
                        ColumnDefinitions="*,*"
                        ColumnSpacing="8"
                        RowDefinitions="Auto,Auto"
                        RowSpacing="8">

                        <!--  ChatGPT  -->
                        <Button
                            Grid.Row="0"
                            Grid.Column="0"
                            Style="{StaticResource AiButtonStyle}"
                            Text="ChatGPT"
                            TextColor="{StaticResource TextLight}"
                            Command="{Binding SendPromptToCommand}">
                            <Button.CommandParameter>
                                <models:NavigationParams PageName="ChatGptPage" ToolName="ChatGPT" />
                            </Button.CommandParameter>
                            <Button.ImageSource>
                                <FontImageSource
                                    FontFamily="MaterialIconsOutlined-Regular"
                                    Glyph="&#xe0ca;"
                                    Color="{StaticResource TextLight}" />
                            </Button.ImageSource>
                        </Button>

                        <!--  Gemini  -->
                        <Button
                            Grid.Row="0"
                            Grid.Column="1"
                            Style="{StaticResource AiButtonStyle}"
                            Text="Gemini"
                            TextColor="{StaticResource TextLight}"
                            Command="{Binding SendPromptToCommand}">
                            <Button.CommandParameter>
                                <models:NavigationParams PageName="GeminiPage" ToolName="Gemini" />
                            </Button.CommandParameter>
                            <Button.ImageSource>
                                <FontImageSource
                                    FontFamily="MaterialIconsOutlined-Regular"
                                    Glyph="&#xe86c;"
                                    Color="{StaticResource TextLight}" />
                            </Button.ImageSource>
                        </Button>

                        <!--  Grok  -->
                        <Button
                            Grid.Row="1"
                            Grid.Column="0"
                            Style="{StaticResource AiButtonStyle}"
                            Text="Grok"
                            TextColor="{StaticResource TextLight}"
                            Command="{Binding SendPromptToCommand}">
                            <Button.CommandParameter>
                                <models:NavigationParams PageName="GrokPage" ToolName="Grok" />
                            </Button.CommandParameter>
                            <Button.ImageSource>
                                <FontImageSource
                                    FontFamily="MaterialIconsOutlined-Regular"
                                    Glyph="&#xe887;"
                                    Color="{StaticResource TextLight}" />
                            </Button.ImageSource>
                        </Button>

                        <!--  Copilot  -->
                        <Button
                            Grid.Row="1"
                            Grid.Column="1"
                            Style="{StaticResource AiButtonStyle}"
                            Text="Copilot"
                            TextColor="{StaticResource TextLight}"
                            Command="{Binding SendPromptToCommand}">
                            <Button.CommandParameter>
                                <models:NavigationParams PageName="CopilotChatPage" ToolName="Copilot" />
                            </Button.CommandParameter>
                            <Button.ImageSource>
                                <FontImageSource
                                    FontFamily="MaterialIconsOutlined-Regular"
                                    Glyph="&#xf02b;"
                                    Color="{StaticResource TextLight}" />
                            </Button.ImageSource>
                        </Button>

                    </Grid>

                </VerticalStackLayout>
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>