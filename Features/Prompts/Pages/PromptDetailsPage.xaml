<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.PromptDetailsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:QuickPrompt.Models"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    xmlns:buttons="clr-namespace:QuickPrompt.Components.Buttons"
    x:Name="promptDetailsPage"
    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceBackgroundLight}, Dark={StaticResource SurfaceBackgroundDark}}"
    Shell.PresentationMode="Animated">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False" />
    </Shell.BackButtonBehavior>

    <Shell.TitleView>
        <views:TitleHeader
            Title="Prompt Designer"
            BackCommand="{Binding MyBackCommand}"
            Glyph="&#xe5e0;"
            ShowBackButton="True" />
    </Shell.TitleView>

    <ContentPage.ToolbarItems>
        <ToolbarItem
            Command="{Binding SharePromptCommand}"
            IsEnabled="{Binding IsShareButtonVisible}"
            Text="Share">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe80d;"
                    Color="{AppThemeBinding Light={StaticResource PrimaryBlueDark}, Dark={StaticResource PrimaryBlueLight}}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>

        <ToolbarItem
            Command="{Binding NavigateToEditPromptCommand}"
            CommandParameter="{Binding PromptID}"
            Text="Edit">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe3c9;"
                    Color="{AppThemeBinding Light={StaticResource PrimaryBlueDark}, Dark={StaticResource PrimaryBlueLight}}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>

        <ToolbarItem 
            Command="{Binding ClearTextCommand}" 
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe5c9;"
                    Color="{StaticResource PrimaryRed}" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>
                Click to Clear Text
            </ToolTipProperties.Text>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout
            Padding="16,16,16,32"
            Spacing="20">

            <!--  Overlay de carga  -->
            <views:ReusableLoadingOverlay
                x:Name="LoadingOverlay"
                IsVisible="{Binding IsLoading}"
                Message="Loading..." />

            <!--  âœ… Header Card - Dark Mode  -->
            <Border 
                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceCardLight}, Dark={StaticResource SurfaceCardDark}}"
                StrokeThickness="0"
                Padding="16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow 
                        Brush="{AppThemeBinding Light={StaticResource AppBlackLight}, Dark=#000000}" 
                        Opacity="0.15" 
                        Radius="12" 
                        Offset="0,4" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="12">
                    
                    <!--  TÃ­tulo Principal  -->
                    <Label
                        FontFamily="Nasa21"
                        FontSize="24"
                        FontAttributes="Bold"
                        Text="{Binding PromptTitle}"
                        TextColor="{AppThemeBinding Light={StaticResource PrimaryBlueDark}, Dark={StaticResource PrimaryBlueLight}}"
                        HorizontalTextAlignment="Center" />

                    <!--  CategorÃ­a Badge  -->
                    <Border
                        BackgroundColor="{StaticResource PrimaryYellow}"
                        HorizontalOptions="Center"
                        Padding="10,6"
                        StrokeThickness="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="16" />
                        </Border.StrokeShape>
                        
                        <Label
                            FontFamily="Nasa21"
                            FontSize="12"
                            FontAttributes="Bold"
                            Text="{Binding Category, Converter={StaticResource CategoryToDisplayNameConverter}}"
                            TextColor="{StaticResource White}" />
                    </Border>

                    <!--  DescripciÃ³n  -->
                    <Label
                        FontFamily="Nasa21"
                        FontSize="14"
                        Text="{Binding Description}"
                        TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        HorizontalTextAlignment="Center"
                        Margin="0,8,0,0"
                        LineBreakMode="WordWrap" />

                </VerticalStackLayout>
            </Border>

            <!--  âœ… Prompt Template Card - Dark Mode  -->
            <Border 
                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceCardLight}, Dark={StaticResource SurfaceCardDark}}"
                StrokeThickness="0"
                Padding="16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow 
                        Brush="{AppThemeBinding Light={StaticResource AppBlackLight}, Dark=#000000}" 
                        Opacity="0.15" 
                        Radius="12" 
                        Offset="0,4" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="12">
                    
                    <Label
                        FontFamily="Nasa21"
                        FontSize="18"
                        FontAttributes="Bold"
                        Text="ðŸ“ Prompt Template"
                        TextColor="{AppThemeBinding Light={StaticResource PrimaryBlueDark}, Dark={StaticResource PrimaryBlueLight}}" />

                    <Border
                        BackgroundColor="{AppThemeBinding Light=#EFF6FF, Dark=#1E3A5F}"
                        Stroke="{AppThemeBinding Light=#BFDBFE, Dark=#3B82F6}"
                        StrokeThickness="1"
                        Padding="12">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>

                        <Label
                            FontFamily="Nasa21"
                            FontSize="14"
                            Text="{Binding PromptText}"
                            TextColor="{AppThemeBinding Light=#1D4ED8, Dark=#93C5FD}"
                            LineBreakMode="WordWrap" />
                    </Border>

                </VerticalStackLayout>
            </Border>

            <!--  âœ… Variables Card - Dark Mode  -->
            <Border 
                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceCardLight}, Dark={StaticResource SurfaceCardDark}}"
                StrokeThickness="0"
                Padding="16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow 
                        Brush="{AppThemeBinding Light={StaticResource AppBlackLight}, Dark=#000000}" 
                        Opacity="0.15" 
                        Radius="12" 
                        Offset="0,4" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="12">
                    
                    <Label
                        FontFamily="Nasa21"
                        FontSize="18"
                        FontAttributes="Bold"
                        Text="âœï¸ Complete the Variables"
                        TextColor="{AppThemeBinding Light={StaticResource PrimaryBlueDark}, Dark={StaticResource PrimaryBlueLight}}" />

                    <CollectionView
                        x:Name="VariablesCollection"
                        ItemsSource="{Binding Variables}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <VerticalStackLayout 
                                    Padding="4" 
                                    Spacing="6">

                                    <Label
                                        FontFamily="Nasa21"
                                        FontSize="14"
                                        FontAttributes="Bold"
                                        Text="{Binding Name}"
                                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />

                                    <Border 
                                        BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                                        Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                                        StrokeThickness="1"
                                        Padding="12,0">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8" />
                                        </Border.StrokeShape>
                                        
                                        <Entry
                                            Focused="OnEntryFocused"
                                            Placeholder="Enter value here..."
                                            FontFamily="Nasa21"
                                            FontSize="15"
                                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                            PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                            BackgroundColor="Transparent"
                                            Text="{Binding Value}"
                                            Unfocused="OnEntryUnfocused"
                                            HeightRequest="46"
                                            VerticalOptions="Center">
                                            <Entry.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnEntryTapped" />
                                            </Entry.GestureRecognizers>
                                        </Entry>
                                    </Border>

                                    <!--  Sugerencias desde cachÃ©  -->
                                    <CollectionView
                                        Margin="0,4,0,8"
                                        IsVisible="{Binding ShowSuggestions}"
                                        ItemsLayout="HorizontalList"
                                        ItemsSource="{Binding Suggestions}"
                                        SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border 
                                                    BackgroundColor="{AppThemeBinding Light=#F3F4F6, Dark=#374151}"
                                                    Stroke="{AppThemeBinding Light=#D1D5DB, Dark=#4B5563}"
                                                    StrokeThickness="1"
                                                    Padding="10,6"
                                                    Margin="4,0">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="16" />
                                                    </Border.StrokeShape>
                                                    
                                                    <Label
                                                        FontFamily="Nasa21"
                                                        FontSize="12"
                                                        Text="{Binding .}"
                                                        TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}">
                                                        <Label.GestureRecognizers>
                                                            <TapGestureRecognizer 
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type models:VariableInput}}, Path=ApplySuggestionCommand}" 
                                                                CommandParameter="{Binding .}" />
                                                        </Label.GestureRecognizers>
                                                    </Label>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </VerticalStackLayout>
            </Border>

            <!--  âœ… Generate Button  -->
            <buttons:PrimaryButton
                Command="{Binding GeneratePromptCommand}"
                Text="Generate Prompt">
                <buttons:PrimaryButton.ImageSource>
                    <FontImageSource
                        FontFamily="MaterialIconsOutlined-Regular"
                        Glyph="&#xe26c;"
                        Color="{StaticResource White}" />
                </buttons:PrimaryButton.ImageSource>
            </buttons:PrimaryButton>

            <!--  âœ… Generated Prompt Result - Dark Mode  -->
            <Border
                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceCardLight}, Dark={StaticResource SurfaceCardDark}}"
                Stroke="{AppThemeBinding Light={StaticResource BorderLightLight}, Dark={StaticResource BorderLightDark}}"
                StrokeThickness="1"
                Padding="16"
                IsVisible="{Binding FinalPrompt, Converter={StaticResource FinalPromptVisibilityConverter}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                
                <VerticalStackLayout Spacing="10">
                    
                    <Label
                        FontFamily="Nasa21"
                        FontSize="18"
                        FontAttributes="Bold"
                        Text="âœ¨ Generated Prompt"
                        TextColor="{StaticResource Success}" />

                    <Label
                        FontFamily="Nasa21"
                        FontSize="14"
                        Text="{Binding FinalPrompt}"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                        LineBreakMode="WordWrap" />

                </VerticalStackLayout>
            </Border>

            <!--  âœ… AI Providers Card - Dark Mode  -->
            <Border
                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceCardLight}, Dark={StaticResource SurfaceCardDark}}"
                StrokeThickness="0"
                Padding="16"
                IsVisible="{Binding ShowPromptActions}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow 
                        Brush="{AppThemeBinding Light={StaticResource AppBlackLight}, Dark=#000000}" 
                        Opacity="0.15" 
                        Radius="12" 
                        Offset="0,4" />
                </Border.Shadow>
                
                <VerticalStackLayout Spacing="16">
                    
                    <Label
                        FontFamily="Nasa21"
                        FontSize="18"
                        FontAttributes="Bold"
                        Text="ðŸ¤– Select an AI Provider"
                        TextColor="{AppThemeBinding Light={StaticResource PrimaryBlueDark}, Dark={StaticResource PrimaryBlueLight}}"
                        HorizontalTextAlignment="Center" />

                    <!--  AI Buttons Grid  -->
                    <Grid
                        ColumnDefinitions="*,*"
                        ColumnSpacing="12"
                        RowDefinitions="Auto,Auto"
                        RowSpacing="12">

                        <!--  ChatGPT  -->
                        <Button
                            Grid.Row="0"
                            Grid.Column="0"
                            BackgroundColor="#10A37F"
                            TextColor="White"
                            FontFamily="Nasa21"
                            FontSize="14"
                            FontAttributes="Bold"
                            Text="ChatGPT"
                            CornerRadius="8"
                            HeightRequest="56"
                            Command="{Binding SendPromptToCommand}">
                            <Button.CommandParameter>
                                <models:NavigationParams PageName="ChatGptPage" ToolName="ChatGPT" />
                            </Button.CommandParameter>
                        </Button>

                        <!--  Gemini  -->
                        <Button
                            Grid.Row="0"
                            Grid.Column="1"
                            BackgroundColor="#8AB4F8"
                            TextColor="White"
                            FontFamily="Nasa21"
                            FontSize="14"
                            FontAttributes="Bold"
                            Text="Gemini"
                            CornerRadius="8"
                            HeightRequest="56"
                            Command="{Binding SendPromptToCommand}">
                            <Button.CommandParameter>
                                <models:NavigationParams PageName="GeminiPage" ToolName="Gemini" />
                            </Button.CommandParameter>
                        </Button>

                        <!--  Grok  -->
                        <Button
                            Grid.Row="1"
                            Grid.Column="0"
                            BackgroundColor="#000000"
                            TextColor="White"
                            FontFamily="Nasa21"
                            FontSize="14"
                            FontAttributes="Bold"
                            Text="Grok"
                            CornerRadius="8"
                            HeightRequest="56"
                            Command="{Binding SendPromptToCommand}">
                            <Button.CommandParameter>
                                <models:NavigationParams PageName="GrokPage" ToolName="Grok" />
                            </Button.CommandParameter>
                        </Button>

                        <!--  Copilot  -->
                        <Button
                            Grid.Row="1"
                            Grid.Column="1"
                            BackgroundColor="#0078D4"
                            TextColor="White"
                            FontFamily="Nasa21"
                            FontSize="14"
                            FontAttributes="Bold"
                            Text="Copilot"
                            CornerRadius="8"
                            HeightRequest="56"
                            Command="{Binding SendPromptToCommand}">
                            <Button.CommandParameter>
                                <models:NavigationParams PageName="CopilotChatPage" ToolName="Copilot" />
                            </Button.CommandParameter>
                        </Button>

                    </Grid>

                </VerticalStackLayout>
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>