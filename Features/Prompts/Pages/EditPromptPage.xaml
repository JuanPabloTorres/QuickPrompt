<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.EditPromptPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceBackgroundLight}, Dark={StaticResource SurfaceBackgroundDark}}"
    Shell.PresentationMode="Animated">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False" />
    </Shell.BackButtonBehavior>

    <Shell.TitleView>
        <views:TitleHeader
            Title="Edit Prompt"
            BackCommand="{Binding MyBackCommand}"
            ShowBackButton="True" />
    </Shell.TitleView>

    <ContentPage.ToolbarItems>
        <!--  Create Variable  -->
        <ToolbarItem Command="{Binding CreateVariableCommand}" IsEnabled="{Binding HasTextSelected}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="MaterialIconsOutlined-Regular" Glyph="&#xe146;" Color="{StaticResource PrimaryRed}" Size="24" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Create Variable</ToolTipProperties.Text>
        </ToolbarItem>

        <!--  Save  -->
        <ToolbarItem Command="{Binding UpdateChangesCommand}" IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="MaterialIconsOutlined-Regular" Glyph="&#xf232;" Color="{StaticResource PrimaryBlueDark}" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Save Changes</ToolTipProperties.Text>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!--  Title  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Title" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12,0">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Grid HeightRequest="46">
                        <Entry
                            Text="{Binding PromptTemplate.Title, Mode=TwoWay}"
                            Placeholder="Prompt title..."
                            FontSize="15" FontFamily="Nasa21"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                            PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                            BackgroundColor="Transparent" VerticalOptions="Center" />
                    </Grid>
                </Border>
            </VerticalStackLayout>

            <!--  Description  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Description" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Editor
                        Placeholder="Optional description..."
                        Text="{Binding PromptTemplate.Description, Mode=TwoWay}"
                        FontSize="15" FontFamily="Nasa21"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                        PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        BackgroundColor="Transparent"
                        AutoSize="TextChanges" MinimumHeightRequest="80" />
                </Border>
            </VerticalStackLayout>

            <!--  Category  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Category" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="4,0">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Picker
                        Title="Select category"
                        ItemsSource="{Binding Categories}"
                        SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                        FontSize="15" 
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                        TitleColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        HeightRequest="46" VerticalOptions="Center" />
                </Border>
            </VerticalStackLayout>

            <!--  Template  -->
            <VerticalStackLayout Spacing="8">
                <Grid ColumnDefinitions="*,Auto">
                    <Label 
                        Text="Template" 
                        FontSize="15" 
                        FontFamily="Nasa21" 
                        FontAttributes="Bold" 
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                    <HorizontalStackLayout Grid.Column="1" Spacing="4">
                        <Border Padding="12,6" BackgroundColor="{StaticResource Gray100}" StrokeThickness="0">
                            <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SwitchToEditorCommand}" />
                            </Border.GestureRecognizers>
                            <Label Text="âœï¸ Text" FontSize="12" TextColor="{StaticResource PrimaryBlue}" />
                        </Border>
                        <Border Padding="12,6" BackgroundColor="{StaticResource PrimaryBlue}" StrokeThickness="0">
                            <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SwitchToChipsCommand}" />
                            </Border.GestureRecognizers>
                            <Label Text="ğŸ¨ Visual" FontSize="12" TextColor="White" />
                        </Border>
                    </HorizontalStackLayout>
                </Grid>

                <!--  Instructions  -->
                <Border
                    BackgroundColor="{AppThemeBinding Light=#EFF6FF, Dark=#1E3A5F}"
                    Stroke="{AppThemeBinding Light=#BFDBFE, Dark=#3B82F6}"
                    StrokeThickness="1"
                    Padding="12"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <VerticalStackLayout Spacing="6">
                        <Label 
                            Text="ğŸ’¡ How to create variables:" 
                            FontSize="13" 
                            FontAttributes="Bold" 
                            TextColor="{AppThemeBinding Light=#1D4ED8, Dark=#93C5FD}" />
                        <Label 
                            Text="â€¢ Select text â†’ tap â• in toolbar" 
                            FontSize="12" 
                            TextColor="{AppThemeBinding Light=#2563EB, Dark=#BFDBFE}" />
                        <Label 
                            Text="â€¢ Or type directly: &lt;variable_name&gt;" 
                            FontSize="12" 
                            TextColor="{AppThemeBinding Light=#2563EB, Dark=#BFDBFE}" />
                    </VerticalStackLayout>
                </Border>

                <!--  Text Editor  -->
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Editor
                        x:Name="PromptRawEditor"
                        Placeholder="Your prompt template..."
                        Text="{Binding PromptTemplate.Template, Mode=TwoWay}"
                        CursorPosition="{Binding CursorPosition, Mode=TwoWay}"
                        SelectionLength="{Binding SelectionLength, Mode=TwoWay}"
                        FontSize="15" FontFamily="Nasa21"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                        PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        BackgroundColor="Transparent"
                        AutoSize="TextChanges" MinimumHeightRequest="150" />
                </Border>

                <!--  Visual Mode  -->
                <Border
                    IsVisible="{Binding IsVisualModeActive}"
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1"
                    Padding="12" MinimumHeightRequest="120">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    <FlexLayout
                        x:Name="PromptChipContainer"
                        Wrap="Wrap" Direction="Row"
                        AlignItems="Center" JustifyContent="Start" />
                </Border>

                <Label
                    Text="ğŸ‘† Tap any chip to edit the variable name"
                    FontSize="12" FontFamily="Nasa21" 
                    TextColor="{AppThemeBinding Light={StaticResource TextTertiaryLight}, Dark={StaticResource TextTertiaryDark}}"
                    HorizontalOptions="Center"
                    IsVisible="{Binding IsVisualModeActive}" />
            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>