<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.EditPromptPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceBackgroundLight}, Dark={StaticResource SurfaceBackgroundDark}}"
    Shell.PresentationMode="Animated">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False" />
    </Shell.BackButtonBehavior>

    <Shell.TitleView>
        <views:TitleHeader
            Title="Edit Prompt"
            BackCommand="{Binding MyBackCommand}"
            ShowBackButton="True" />
    </Shell.TitleView>

    <ContentPage.ToolbarItems>
        <!--  Save  -->
        <ToolbarItem Command="{Binding UpdateChangesCommand}" IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="MaterialIconsOutlined-Regular" Glyph="&#xf232;" Color="{StaticResource PrimaryBlueDark}" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Save Changes</ToolTipProperties.Text>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <!--  âœ¨ Main content only -->
    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!--  Title  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Title" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12,0">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    <Grid HeightRequest="46">
                        <Entry
                            Text="{Binding PromptTemplate.Title, Mode=TwoWay}"
                            Placeholder="Prompt title..."
                            FontSize="15" FontFamily="Nasa21"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                            PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                            BackgroundColor="Transparent" VerticalOptions="Center" />
                    </Grid>
                </Border>
            </VerticalStackLayout>

            <!--  Description  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Description" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    <Editor
                        Placeholder="Optional description..."
                        Text="{Binding PromptTemplate.Description, Mode=TwoWay}"
                        FontSize="15" FontFamily="Nasa21"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                        PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        BackgroundColor="Transparent"
                        AutoSize="TextChanges" MinimumHeightRequest="80" />
                </Border>
            </VerticalStackLayout>

            <!--  Category  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Category" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="4,0">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    <Picker
                        Title="Select category"
                        ItemsSource="{Binding Categories}"
                        SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                        FontSize="15" 
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                        TitleColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        HeightRequest="46" VerticalOptions="Center" />
                </Border>
            </VerticalStackLayout>

            <!--  Template header compact  -->
            <VerticalStackLayout Spacing="8">
                <Grid ColumnDefinitions="Auto,*">
                    <Label 
                        Text="Template" 
                        FontSize="15" 
                        FontFamily="Nasa21" 
                        FontAttributes="Bold" 
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                        VerticalOptions="Center" />
                    <ScrollView Grid.Column="1" Orientation="Horizontal" HorizontalScrollBarVisibility="Never" WidthRequest="320" HorizontalOptions="End">
                        <HorizontalStackLayout Spacing="6" Padding="0" VerticalOptions="Center">
                            <!-- Text chip -->
                            <Border Padding="10,6" BackgroundColor="{StaticResource Gray100}" StrokeThickness="0">
                                <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SwitchToEditorCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Label Text="âœï¸" FontSize="12" />
                                    <Label Text="Text" FontSize="12" TextColor="{StaticResource PrimaryBlue}" />
                                </HorizontalStackLayout>
                            </Border>
                            <!-- Visual chip -->
                            <Border Padding="10,6" BackgroundColor="{StaticResource PrimaryBlue}" StrokeThickness="0">
                                <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SwitchToChipsCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Label Text="ğŸ¨" FontSize="12" TextColor="White" />
                                    <Label Text="Visual" FontSize="12" TextColor="White" />
                                </HorizontalStackLayout>
                            </Border>
                            <!-- Make Variable chip -->
                            <Border BackgroundColor="{StaticResource Gray100}" Padding="10,6" StrokeThickness="0" IsEnabled="{Binding HasTextSelected}">
                                <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnCreateVariableFromSelection" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Label FontFamily="MaterialIconsOutlined-Regular" Text="&#xe146;" FontSize="14" TextColor="{StaticResource PrimaryBlue}" />
                                    <Label Text="Variable" FontFamily="Nasa21" FontSize="12" TextColor="{StaticResource PrimaryBlueDark}" />
                                </HorizontalStackLayout>
                            </Border>
                            <!-- Remove chip -->
                            <Border BackgroundColor="{StaticResource Gray100}" Padding="10,6" StrokeThickness="0" IsEnabled="{Binding HasTextSelected}">
                                <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnUndoVariableFromSelection" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Label FontFamily="MaterialIconsOutlined-Regular" Text="&#xe14c;" FontSize="14" TextColor="{StaticResource PrimaryRed}" />
                                    <Label Text="Remove" FontFamily="Nasa21" FontSize="12" TextColor="{StaticResource PrimaryRed}" />
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>
                    </ScrollView>
                </Grid>

                <!--  Instructions  -->
                <Border
                    BackgroundColor="{AppThemeBinding Light=#F1F5F9, Dark=#0F172A}"
                    Stroke="{AppThemeBinding Light=#CBD5E1, Dark=#334155}"
                    StrokeThickness="1"
                    Padding="12"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    <VerticalStackLayout Spacing="6">
                        <Label 
                            Text="ğŸ’¡ How to create variables:" 
                            FontSize="13" 
                            FontAttributes="Bold" 
                            TextColor="{AppThemeBinding Light=#0F172A, Dark=#E2E8F0}" />
                        <Label 
                            Text="â€¢ Select text â†’ floating button appears automatically" 
                            FontSize="12" 
                            TextColor="{AppThemeBinding Light=#1F2937, Dark=#CBD5E1}" />
                        <Label 
                            Text="â€¢ Blue button for text, Red button for variables" 
                            FontSize="12" 
                            TextColor="{AppThemeBinding Light=#1F2937, Dark=#CBD5E1}" />
                        <Label 
                            Text="â€¢ Or type directly: &lt;variable_name&gt;" 
                            FontSize="12" 
                            TextColor="{AppThemeBinding Light=#1F2937, Dark=#CBD5E1}" />
                    </VerticalStackLayout>
                </Border>

                <!--  Text Editor  -->
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    
                    <Editor
                        x:Name="PromptRawEditor"
                        Placeholder="Your prompt template..."
                        Text="{Binding PromptTemplate.Template, Mode=TwoWay}"
                        CursorPosition="{Binding CursorPosition, Mode=TwoWay}"
                        SelectionLength="{Binding SelectionLength, Mode=TwoWay}"
                        FontSize="15" FontFamily="Nasa21"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                        PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        BackgroundColor="Transparent"
                        AutoSize="TextChanges" MinimumHeightRequest="150"
                        Focused="OnEditorFocused"
                        Unfocused="OnEditorUnfocused" />
                </Border>

                <!--  Visual Mode  -->
                <Border
                    IsVisible="{Binding IsVisualModeActive}"
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1"
                    Padding="12" MinimumHeightRequest="120">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    <FlexLayout
                        x:Name="PromptChipContainer"
                        Wrap="Wrap" Direction="Row"
                        AlignItems="Center" JustifyContent="Start" />
                </Border>

                <Label
                    Text="ğŸ‘† Tap any chip to edit the variable name"
                    FontSize="12" FontFamily="Nasa21" 
                    TextColor="{AppThemeBinding Light={StaticResource TextTertiaryLight}, Dark={StaticResource TextTertiaryDark}}"
                    HorizontalOptions="Center"
                    IsVisible="{Binding IsVisualModeActive}" />

            </VerticalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>