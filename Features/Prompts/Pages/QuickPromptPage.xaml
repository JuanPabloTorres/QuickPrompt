<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.QuickPromptPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:buttons="clr-namespace:QuickPrompt.Components.Buttons"
    xmlns:containers="clr-namespace:QuickPrompt.Components.Containers"
    xmlns:localcontrols="clr-namespace:QuickPrompt.Controls"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    xmlns:vm="clr-namespace:QuickPrompt.ViewModels"
    AutomationProperties.HelpText="Browse and manage your saved prompts"
    AutomationProperties.Name="Quick Prompt Page"
    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceBackgroundLight}, Dark={StaticResource SurfaceBackgroundDark}}"
    Shell.PresentationMode="Animated">

    <Shell.TitleView>
        <Label
            FontAttributes="Bold"
            FontFamily="Nasa21"
            FontSize="18"
            Text="Quick Prompt"
            TextColor="{StaticResource PrimaryBlueDark}"
            VerticalOptions="Center" />
    </Shell.TitleView>

    <!--  Toolbar  -->
    <ContentPage.ToolbarItems>

        <ToolbarItem Command="{Binding LoadInitialPromptsCommand}" IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe5d5;"
                    Color="{StaticResource PrimaryBlueDark}" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Reload Prompts</ToolTipProperties.Text>
            <AutomationProperties.Name>Reload</AutomationProperties.Name>
            <AutomationProperties.HelpText>Reload all prompts from database</AutomationProperties.HelpText>
        </ToolbarItem>

        <ToolbarItem Command="{Binding DeleteSelectedPromptsCommand}" IsEnabled="{Binding SelectedPromptsToDelete.Count, Converter={StaticResource SelectedPromptsVisibilityConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe92b;"
                    Color="{StaticResource PrimaryRed}" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Delete Selected Prompts</ToolTipProperties.Text>
            <AutomationProperties.Name>Delete Selected</AutomationProperties.Name>
            <AutomationProperties.HelpText>Delete all selected prompts</AutomationProperties.HelpText>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,Auto,*">

        <!--  Loading Overlay  -->
        <views:ReusableLoadingOverlay
            x:Name="LoadingOverlay"
            Grid.Row="0"
            Grid.RowSpan="3"
            IsVisible="{Binding IsLoading}"
            Message="Loading prompts..." />

        <!--  Google AdMob Banner  -->
        <views:AdmobBannerView Grid.Row="0" IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />

        <!--  Filter Bar  -->
        <views:PromptFilterBar
            Grid.Row="1"
            Margin="16,8"
            Categories="{Binding Categories}"
            SearchCommand="{Binding FilterPromptsCommand}"
            SearchText="{Binding Search}"
            SelectedCategory="{Binding SelectedCategory}"
            SelectedFilter="{Binding SelectedDateFilter}" />

        <!--  Prompts List  -->
        <ScrollView Grid.Row="2">
            <VerticalStackLayout Padding="16,0,16,32" Spacing="16">

                <CollectionView
                    IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
                    ItemsSource="{Binding Prompts}"
                    SelectionMode="None">

                    <CollectionView.EmptyView>
                        <localcontrols:EmptyStateView
                            Title="No prompts found"
                            ButtonText="Create First Prompt"
                            Description="{Binding EmptyViewText}"
                            Icon="{x:Static localcontrols:EmptyStates+Icons.Inbox}"
                            ShowButton="True">
                            <localcontrols:EmptyStateView.ButtonCommand>
                                <Binding Path="NavigateToCreateCommand" />
                            </localcontrols:EmptyStateView.ButtonCommand>
                        </localcontrols:EmptyStateView>
                    </CollectionView.EmptyView>

                    <CollectionView.Header>
                        <VerticalStackLayout Spacing="12">

                            <!--  Header with Select All  -->
                            <Grid ColumnDefinitions="*,Auto">
                                <Label
                                    Grid.Column="0"
                                    Style="{StaticResource Heading2TextStyle}"
                                    Text="My Prompts"
                                    VerticalOptions="Center" />

                                <!--  Select All toggle  -->
                                <HorizontalStackLayout
                                    Grid.Column="1"
                                    Spacing="8"
                                    VerticalOptions="Center">
                                    <Label
                                        Style="{StaticResource BodySmallTextStyle}"
                                        Text="Select All"
                                        VerticalOptions="Center" />
                                    <CheckBox
                                        CheckedChanged="OnSelectAllCheckedChanged"
                                        IsChecked="{Binding IsAllSelected, Mode=TwoWay}"
                                        VerticalOptions="Center"
                                        Color="{StaticResource PrimaryRed}" />
                                </HorizontalStackLayout>
                            </Grid>

                            <!--  Divider  -->
                            <BoxView 
                                BackgroundColor="{AppThemeBinding Light={StaticResource BorderLightLight}, Dark={StaticResource BorderLightDark}}" 
                                HeightRequest="1" />

                        </VerticalStackLayout>
                    </CollectionView.Header>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <!--  Prompt Card  -->
                            <Border
                                Margin="0,0,0,12"
                                Padding="16"
                                BackgroundColor="{AppThemeBinding Light={StaticResource CardBackgroundLight}, Dark={StaticResource CardBackgroundDark}}"
                                StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Border.Shadow>
                                    <Shadow
                                        Brush="{AppThemeBinding Light={StaticResource AppBlackLight}, Dark=#000000}"
                                        Opacity="0.1"
                                        Radius="8"
                                        Offset="0,2" />
                                </Border.Shadow>

                                <VerticalStackLayout Spacing="12">

                                    <!--  Header: Title + Favorite  -->
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label
                                            Grid.Column="0"
                                            LineBreakMode="TailTruncation"
                                            MaxLines="2"
                                            Style="{StaticResource Heading3TextStyle}"
                                            Text="{Binding Prompt.Title}"
                                            VerticalOptions="Center" />

                                        <Button
                                            Grid.Column="1"
                                            Padding="0"
                                            BackgroundColor="{StaticResource PrimaryYellow}"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:QuickPromptViewModel}}, Path=ToggleFavoriteCommand}"
                                            CommandParameter="{Binding .}"
                                            CornerRadius="22"
                                            HeightRequest="44"
                                            VerticalOptions="Center"
                                            WidthRequest="44">
                                            <Button.ImageSource>
                                                <FontImageSource
                                                    FontFamily="MaterialIconsOutlined-Regular"
                                                    Glyph="{Binding IsFavorite, Converter={StaticResource BooleanToStarIconConverter}}"
                                                    Size="20"
                                                    Color="White" />
                                            </Button.ImageSource>
                                        </Button>
                                    </Grid>

                                    <!--  Category Badge  -->
                                    <Border
                                        Padding="10,4"
                                        BackgroundColor="{StaticResource PrimaryRed}"
                                        HorizontalOptions="Start"
                                        StrokeThickness="0">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>

                                        <Label
                                            FontAttributes="Bold"
                                            Style="{StaticResource CaptionTextStyle}"
                                            Text="{Binding Prompt.Category, Converter={StaticResource CategoryToDisplayNameConverter}}"
                                            TextColor="White" />
                                    </Border>

                                    <!--  Description  -->
                                    <Label
                                        LineBreakMode="WordWrap"
                                        MaxLines="3"
                                        Style="{StaticResource BodyTextStyle}"
                                        Text="{Binding Prompt.Description}"
                                        TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />

                                    <!--  Divider  -->
                                    <BoxView 
                                        BackgroundColor="{AppThemeBinding Light={StaticResource BorderLightLight}, Dark={StaticResource BorderLightDark}}" 
                                        HeightRequest="1" />

                                    <!--  Action Buttons Row  -->
                                    <Grid ColumnDefinitions="*,*,*,*,Auto" ColumnSpacing="8">

                                        <!--  Use Button  -->
                                        <Button
                                            Grid.Column="0"
                                            Padding="0"
                                            AutomationProperties.HelpText="Use this prompt to generate content"
                                            AutomationProperties.Name="Use Prompt"
                                            BackgroundColor="{StaticResource PrimaryBlueDark}"
                                            Command="{Binding SelectPromptCommand}"
                                            CommandParameter="{Binding Prompt}"
                                            CornerRadius="8"
                                            HeightRequest="44"
                                            ToolTipProperties.Text="Use this prompt"
                                            WidthRequest="44">
                                            <Button.ImageSource>
                                                <FontImageSource
                                                    FontFamily="MaterialIconsOutlined-Regular"
                                                    Glyph="&#xe913;"
                                                    Size="20"
                                                    Color="White" />
                                            </Button.ImageSource>
                                        </Button>

                                        <!--  Edit Button  -->
                                        <Button
                                            Grid.Column="1"
                                            Padding="0"
                                            AutomationProperties.HelpText="Edit this prompt"
                                            AutomationProperties.Name="Edit Prompt"
                                            BackgroundColor="{StaticResource PrimaryTeal}"
                                            Command="{Binding NavigateToEditPromptCommand}"
                                            CommandParameter="{Binding Prompt}"
                                            CornerRadius="8"
                                            HeightRequest="44"
                                            ToolTipProperties.Text="Edit prompt"
                                            WidthRequest="44">
                                            <Button.ImageSource>
                                                <FontImageSource
                                                    FontFamily="MaterialIconsOutlined-Regular"
                                                    Glyph="&#xe3c9;"
                                                    Size="20"
                                                    Color="White" />
                                            </Button.ImageSource>
                                        </Button>

                                        <!--  Delete Button  -->
                                        <Button
                                            Grid.Column="2"
                                            Padding="0"
                                            AutomationProperties.HelpText="Delete this prompt"
                                            AutomationProperties.Name="Delete Prompt"
                                            BackgroundColor="{StaticResource PrimaryRed}"
                                            Command="{Binding ItemToDeleteCommand}"
                                            CornerRadius="8"
                                            HeightRequest="44"
                                            ToolTipProperties.Text="Delete prompt"
                                            WidthRequest="44">
                                            <Button.ImageSource>
                                                <FontImageSource
                                                    FontFamily="MaterialIconsOutlined-Regular"
                                                    Glyph="&#xe92b;"
                                                    Size="20"
                                                    Color="White" />
                                            </Button.ImageSource>
                                        </Button>

                                        <!--  Export Button  -->
                                        <Button
                                            Grid.Column="3"
                                            Padding="0"
                                            AutomationProperties.HelpText="Export this prompt to JSON"
                                            AutomationProperties.Name="Export Prompt"
                                            BackgroundColor="{StaticResource Info600}"
                                            Command="{Binding ExportPromptCommand}"
                                            CommandParameter="{Binding Prompt}"
                                            CornerRadius="8"
                                            HeightRequest="44"
                                            ToolTipProperties.Text="Export prompt"
                                            WidthRequest="44">
                                            <Button.ImageSource>
                                                <FontImageSource
                                                    FontFamily="MaterialIconsOutlined-Regular"
                                                    Glyph="&#xe80d;"
                                                    Size="20"
                                                    Color="White" />
                                            </Button.ImageSource>
                                        </Button>

                                        <!--  Selection CheckBox  -->
                                        <CheckBox
                                            Grid.Column="4"
                                            AutomationProperties.HelpText="Select this prompt for deletion"
                                            AutomationProperties.Name="Select Prompt"
                                            HorizontalOptions="End"
                                            IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                            ToolTipProperties.Text="Select for bulk actions"
                                            VerticalOptions="Center"
                                            Color="{StaticResource PrimaryRed}" />
                                    </Grid>

                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                    <CollectionView.Footer>
                        <VerticalStackLayout Padding="0,16" Spacing="16">

                            <!--  Divider  -->
                            <BoxView 
                                BackgroundColor="{AppThemeBinding Light={StaticResource BorderLightLight}, Dark={StaticResource BorderLightDark}}" 
                                HeightRequest="1" />

                            <!--  Total Count  -->
                            <Label
                                HorizontalOptions="Center"
                                Style="{StaticResource BodySmallTextStyle}"
                                Text="{Binding Prompts.Count, StringFormat='Total: {0} prompts'}"
                                TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />

                            <!--  Load More Button  -->
                            <Button
                                Padding="32,0"
                                BackgroundColor="{StaticResource PrimaryBlue}"
                                Command="{Binding LoadMorePromptsCommand}"
                                CornerRadius="12"
                                FontFamily="Nasa21"
                                FontSize="14"
                                HeightRequest="44"
                                HorizontalOptions="Center"
                                IsEnabled="{Binding IsMoreDataAvailable}"
                                Text="Load More"
                                TextColor="White">

                                <Button.IsVisible>
                                    <MultiBinding Converter="{StaticResource IsButtonVisibleConverter}">
                                        <Binding Path="IsLoading" />
                                        <Binding Path="Prompts.Count" />
                                    </MultiBinding>
                                </Button.IsVisible>

                                <Button.ImageSource>
                                    <FontImageSource
                                        FontFamily="MaterialIconsOutlined-Regular"
                                        Glyph="&#xead0;"
                                        Size="20"
                                        Color="White" />
                                </Button.ImageSource>
                            </Button>

                        </VerticalStackLayout>
                    </CollectionView.Footer>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>

    </Grid>
</ContentPage>