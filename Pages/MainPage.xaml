<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    BackgroundColor="{StaticResource SurfaceBackground}"
    Shell.PresentationMode="Animated">

    <Shell.TitleView>
        <Label
            FontFamily="Nasa21"
            FontSize="20"
            Text="Create Prompt"
            TextColor="{StaticResource PrimaryBlueDark}"
            VerticalOptions="Center" />
    </Shell.TitleView>

    <ContentPage.ToolbarItems>
        <!--  PRIMARY: Create Variable (most used)  -->
        <ToolbarItem Command="{Binding CreateVariableCommand}" IsEnabled="{Binding HasTextSelected}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="MaterialIconsOutlined-Regular" Glyph="&#xe146;" Color="{StaticResource PrimaryRed}" Size="24" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Create Variable</ToolTipProperties.Text>
        </ToolbarItem>

        <!--  PRIMARY: Save  -->
        <ToolbarItem Command="{Binding SavePromptCommand}" IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="MaterialIconsOutlined-Regular" Glyph="&#xe86c;" Color="{StaticResource PrimaryBlueDark}" Size="24" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Save Prompt</ToolTipProperties.Text>
        </ToolbarItem>

        <!--  SECONDARY: Advanced Builder (in overflow menu)  -->
        <ToolbarItem 
            Text="Advanced Builder"
            Order="Secondary"
            Command="{Binding GoToAdvancedBuilderCommand}" 
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />

        <!--  SECONDARY: Import JSON (in overflow menu)  -->
        <ToolbarItem 
            Text="Import JSON"
            Order="Secondary"
            Command="{Binding ImportPromptCommand}" 
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />

        <!--  SECONDARY: Clear All (in overflow menu)  -->
        <ToolbarItem 
            Text="Clear All"
            Order="Secondary"
            Command="{Binding ClearTextCommand}" 
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!--  Title  -->
            <VerticalStackLayout Spacing="6">
                <Label Text="Title" FontSize="15" FontFamily="Nasa21" FontAttributes="Bold" TextColor="#111827" />
                <Border BackgroundColor="White" Stroke="#D1D5DB" StrokeThickness="1" Padding="12,0">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Grid HeightRequest="46">
                        <Entry
                            Text="{Binding PromptTitle, Mode=TwoWay}"
                            Placeholder="My awesome prompt..."
                            FontSize="15" FontFamily="Nasa21"
                            TextColor="#111827" PlaceholderColor="#9CA3AF"
                            BackgroundColor="Transparent" VerticalOptions="Center" />
                    </Grid>
                </Border>
            </VerticalStackLayout>

            <!--  Category  -->
            <VerticalStackLayout Spacing="6">
                <Label Text="Category" FontSize="15" FontFamily="Nasa21" FontAttributes="Bold" TextColor="#111827" />
                <Border BackgroundColor="White" Stroke="#D1D5DB" StrokeThickness="1" Padding="4,0">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Picker
                        Title="Select category"
                        ItemsSource="{Binding Categories}"
                        SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                        FontSize="15" TextColor="#111827" TitleColor="#9CA3AF"
                        HeightRequest="46" VerticalOptions="Center" />
                </Border>
            </VerticalStackLayout>

            <!--  Prompt Template  -->
            <VerticalStackLayout Spacing="8">
                <Grid ColumnDefinitions="*,Auto">
                    <Label Text="Prompt Template" FontSize="15" FontFamily="Nasa21" FontAttributes="Bold" TextColor="#111827" />
                    <HorizontalStackLayout Grid.Column="1" Spacing="4">
                        <Border Padding="12,6" BackgroundColor="{StaticResource Gray100}" StrokeThickness="0">
                            <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SwitchToEditorCommand}" />
                            </Border.GestureRecognizers>
                            <Label Text="✏️ Text" FontSize="12" TextColor="{StaticResource PrimaryBlue}" />
                        </Border>
                        <Border Padding="12,6" BackgroundColor="{StaticResource PrimaryBlue}" StrokeThickness="0">
                            <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SwitchToChipsCommand}" />
                            </Border.GestureRecognizers>
                            <Label Text="🎨 Visual" FontSize="12" TextColor="White" />
                        </Border>
                    </HorizontalStackLayout>
                </Grid>

                <!--  Instructions  -->
                <Border
                    BackgroundColor="#EFF6FF"
                    Stroke="#BFDBFE"
                    StrokeThickness="1"
                    Padding="12"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <VerticalStackLayout Spacing="6">
                        <Label Text="💡 How to create variables:" FontSize="13" FontAttributes="Bold" TextColor="#1D4ED8" />
                        <Label Text="• Select text → tap ➕ in toolbar" FontSize="12" TextColor="#2563EB" />
                        <Label Text="• Or type directly: &lt;variable_name&gt;" FontSize="12" TextColor="#2563EB" />
                    </VerticalStackLayout>
                </Border>

                <!--  Text Editor  -->
                <Border 
                    BackgroundColor="White" Stroke="#D1D5DB" StrokeThickness="1" Padding="12"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Editor
                        x:Name="PromptRawEditor"
                        Placeholder="Write your prompt here...&#x0a;&#x0a;Example: Create a &lt;format&gt; about &lt;topic&gt; for &lt;audience&gt;"
                        Text="{Binding PromptText, Mode=TwoWay}"
                        CursorPosition="{Binding CursorPosition, Mode=TwoWay}"
                        SelectionLength="{Binding SelectionLength, Mode=TwoWay}"
                        FontSize="15" FontFamily="Nasa21"
                        TextColor="#111827" PlaceholderColor="#9CA3AF"
                        BackgroundColor="Transparent"
                        AutoSize="TextChanges"
                        MinimumHeightRequest="180" />
                </Border>

                <!--  Visual Mode  -->
                <Border
                    IsVisible="{Binding IsVisualModeActive}"
                    BackgroundColor="White" Stroke="#D1D5DB" StrokeThickness="1"
                    Padding="12" MinimumHeightRequest="120">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    <FlexLayout
                        x:Name="PromptChipContainer"
                        Wrap="Wrap" Direction="Row"
                        AlignItems="Center" JustifyContent="Start" />
                </Border>

                <Label
                    Text="👆 Tap any chip to edit the variable name"
                    FontSize="12" FontFamily="Nasa21"
                    TextColor="#6B7280"
                    HorizontalOptions="Center"
                    IsVisible="{Binding IsVisualModeActive}" />
            </VerticalStackLayout>

            <!--  Variable Count  -->
            <Border 
                BackgroundColor="#F0FDF4" Stroke="#BBF7D0" StrokeThickness="1" Padding="12"
                IsVisible="{Binding VariableCount, Converter={StaticResource IntToBoolConverter}}">
                <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                <Label 
                    Text="{Binding VariableCount, StringFormat='✅ {0} variable(s) detected'}"
                    FontSize="13" FontFamily="Nasa21" TextColor="#15803D"
                    HorizontalTextAlignment="Center" />
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>