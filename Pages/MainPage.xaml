<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceBackgroundLight},
                                      Dark={StaticResource SurfaceBackgroundDark}}"
    Shell.PresentationMode="Animated">

    <Shell.TitleView>
        <Label
            FontFamily="Nasa21"
            FontSize="20"
            Text="Create Prompt"
            TextColor="{StaticResource PrimaryBlueDark}"
            VerticalOptions="Center" />
    </Shell.TitleView>

    <ContentPage.ToolbarItems>
        <!--  PRIMARY: Save  -->
        <ToolbarItem Command="{Binding SavePromptCommand}" IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource
                    FontFamily="MaterialIconsOutlined-Regular"
                    Glyph="&#xe86c;"
                    Size="24"
                    Color="{StaticResource PrimaryBlueDark}" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Save Prompt</ToolTipProperties.Text>
        </ToolbarItem>

        <!--  SECONDARY: Advanced Builder (in overflow menu)  -->
        <ToolbarItem
            Command="{Binding GoToAdvancedBuilderCommand}"
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
            Order="Secondary"
            Text="Advanced Builder" />

        <!--  SECONDARY: Import JSON (in overflow menu)  -->
        <ToolbarItem
            Command="{Binding ImportPromptCommand}"
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
            Order="Secondary"
            Text="Import JSON" />

        <!--  SECONDARY: Clear All (in overflow menu)  -->
        <ToolbarItem
            Command="{Binding ClearTextCommand}"
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
            Order="Secondary"
            Text="Clear All" />
    </ContentPage.ToolbarItems>

    <!--  Main content only  -->
    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!--  Title  -->
            <VerticalStackLayout Spacing="6">
                <Label
                    FontAttributes="Bold"
                    FontFamily="Nasa21"
                    FontSize="15"
                    Text="Title"
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight},
                                                Dark={StaticResource TextPrimaryDark}}" />
                <Border
                    Padding="12,0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight},
                                                      Dark={StaticResource SurfaceInputDark}}"
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight},
                                             Dark={StaticResource BorderDefaultDark}}"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <Grid HeightRequest="46">
                        <Entry
                            BackgroundColor="Transparent"
                            FontFamily="Nasa21"
                            FontSize="15"
                            Placeholder="My awesome prompt..."
                            PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight},
                                                               Dark={StaticResource TextSecondaryDark}}"
                            Text="{Binding PromptTitle, Mode=TwoWay}"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight},
                                                        Dark={StaticResource TextPrimaryDark}}"
                            VerticalOptions="Center" />
                    </Grid>
                </Border>
            </VerticalStackLayout>

            <!--  Description  -->
            <VerticalStackLayout Spacing="6">
                <Label
                    FontAttributes="Bold"
                    FontFamily="Nasa21"
                    FontSize="15"
                    Text="Description"
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight},
                                                Dark={StaticResource TextPrimaryDark}}" />
                <Border
                    Padding="12"
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight},
                                                      Dark={StaticResource SurfaceInputDark}}"
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight},
                                             Dark={StaticResource BorderDefaultDark}}"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <Editor
                        AutoSize="TextChanges"
                        BackgroundColor="Transparent"
                        FontFamily="Nasa21"
                        FontSize="15"
                        MinimumHeightRequest="80"
                        Placeholder="Optional description..."
                        PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight},
                                                           Dark={StaticResource TextSecondaryDark}}"
                        Text="{Binding PromptDescription, Mode=TwoWay}"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight},
                                                    Dark={StaticResource TextPrimaryDark}}" />
                </Border>
            </VerticalStackLayout>

            <!--  Category  -->
            <VerticalStackLayout Spacing="6">
                <Label
                    FontAttributes="Bold"
                    FontFamily="Nasa21"
                    FontSize="15"
                    Text="Category"
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight},
                                                Dark={StaticResource TextPrimaryDark}}" />
                <Border
                    Padding="4,0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight},
                                                      Dark={StaticResource SurfaceInputDark}}"
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight},
                                             Dark={StaticResource BorderDefaultDark}}"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <Picker
                        Title="Select category"
                        FontSize="15"
                        HeightRequest="46"
                        ItemsSource="{Binding Categories}"
                        SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight},
                                                    Dark={StaticResource TextPrimaryDark}}"
                        TitleColor="{AppThemeBinding Light={StaticResource TextSecondaryLight},
                                                     Dark={StaticResource TextSecondaryDark}}"
                        VerticalOptions="Center" />
                </Border>
            </VerticalStackLayout>

            <!--  Prompt Template header compact  -->
            <VerticalStackLayout Spacing="8">
                <Grid ColumnDefinitions="Auto,*">
                    <Label
                        FontAttributes="Bold"
                        FontFamily="Nasa21"
                        FontSize="15"
                        Text=" Template"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight},
                                                    Dark={StaticResource TextPrimaryDark}}"
                        VerticalOptions="Center" />
                    <ScrollView
                        Grid.Column="1"
                        HorizontalOptions="End"
                        HorizontalScrollBarVisibility="Never"
                        Orientation="Horizontal"
                        WidthRequest="320">
                        <HorizontalStackLayout
                            Padding="0"
                            Spacing="6"
                            VerticalOptions="Center">
                            <!--  Text chip  -->
                            <Border
                                Padding="10,6"
                                BackgroundColor="{StaticResource Gray100}"
                                StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SwitchToEditorCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Label FontSize="12" Text="✏️" />
                                    <Label
                                        FontSize="12"
                                        Text="Text"
                                        TextColor="{StaticResource PrimaryBlue}" />
                                </HorizontalStackLayout>
                            </Border>
                            <!--  Visual chip  -->
                            <Border
                                Padding="10,6"
                                BackgroundColor="{StaticResource PrimaryBlue}"
                                StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SwitchToChipsCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Label
                                        FontSize="12"
                                        Text="🎨"
                                        TextColor="White" />
                                    <Label
                                        FontSize="12"
                                        Text="Visual"
                                        TextColor="White" />
                                </HorizontalStackLayout>
                            </Border>
                            <!--  Make Variable chip  -->
                            <Border
                                Padding="10,6"
                                BackgroundColor="{StaticResource Gray100}"
                                IsEnabled="{Binding HasTextSelected}"
                                StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnCreateVariableFromSelection" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Label
                                        FontFamily="MaterialIconsOutlined-Regular"
                                        FontSize="14"
                                        Text="&#xe146;"
                                        TextColor="{StaticResource PrimaryBlue}" />
                                    <Label
                                        FontFamily="Nasa21"
                                        FontSize="12"
                                        Text="Variable"
                                        TextColor="{StaticResource PrimaryBlueDark}" />
                                </HorizontalStackLayout>
                            </Border>
                            <!--  Remove chip  -->
                            <Border
                                Padding="10,6"
                                BackgroundColor="{StaticResource Gray100}"
                                IsEnabled="{Binding HasTextSelected}"
                                StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="16" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnUndoVariableFromSelection" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Label
                                        FontFamily="MaterialIconsOutlined-Regular"
                                        FontSize="14"
                                        Text="&#xe14c;"
                                        TextColor="{StaticResource PrimaryRed}" />
                                    <Label
                                        FontFamily="Nasa21"
                                        FontSize="12"
                                        Text="Remove"
                                        TextColor="{StaticResource PrimaryRed}" />
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>
                    </ScrollView>
                </Grid>

                <!--  Instructions  -->
                <Border
                    Padding="12"
                    BackgroundColor="{AppThemeBinding Light=#F1F5F9,
                                                      Dark=#0F172A}"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}"
                    Stroke="{AppThemeBinding Light=#CBD5E1,
                                             Dark=#334155}"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="6">
                        <Label
                            FontAttributes="Bold"
                            FontSize="13"
                            Text="💡 How to create variables:"
                            TextColor="{AppThemeBinding Light=#0F172A,
                                                        Dark=#E2E8F0}" />
                        <Label
                            FontSize="12"
                            Text="• Select text → inline buttons appear"
                            TextColor="{AppThemeBinding Light=#1F2937,
                                                        Dark=#CBD5E1}" />
                        <Label
                            FontSize="12"
                            Text="• Blue chip for Text, Visual chip for variables"
                            TextColor="{AppThemeBinding Light=#1F2937,
                                                        Dark=#CBD5E1}" />
                        <Label
                            FontSize="12"
                            Text="• Or type directly: &lt;variable_name&gt;"
                            TextColor="{AppThemeBinding Light=#1F2937,
                                                        Dark=#CBD5E1}" />
                    </VerticalStackLayout>
                </Border>

                <!--  Text Editor  -->
                <Border
                    Padding="12"
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight},
                                                      Dark={StaticResource SurfaceInputDark}}"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}"
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight},
                                             Dark={StaticResource BorderDefaultDark}}"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>

                    <Editor
                        x:Name="PromptRawEditor"
                        AutoSize="TextChanges"
                        BackgroundColor="Transparent"
                        CursorPosition="{Binding CursorPosition, Mode=TwoWay}"
                        Focused="OnEditorFocused"
                        FontFamily="Nasa21"
                        FontSize="15"
                        MinimumHeightRequest="180"
                        Placeholder="Write your prompt here...&#x0a;&#x0a;Example: Create a &lt;format&gt; about &lt;topic&gt; for &lt;audience&gt;"
                        PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight},
                                                           Dark={StaticResource TextSecondaryDark}}"
                        SelectionLength="{Binding SelectionLength, Mode=TwoWay}"
                        Text="{Binding PromptText, Mode=TwoWay}"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight},
                                                    Dark={StaticResource TextPrimaryDark}}"
                        Unfocused="OnEditorUnfocused" />
                </Border>

                <!--  Visual Mode  -->
                <Border
                    Padding="12"
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight},
                                                      Dark={StaticResource SurfaceInputDark}}"
                    IsVisible="{Binding IsVisualModeActive}"
                    MinimumHeightRequest="120"
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight},
                                             Dark={StaticResource BorderDefaultDark}}"
                    StrokeThickness="1">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <FlexLayout
                        x:Name="PromptChipContainer"
                        AlignItems="Center"
                        Direction="Row"
                        JustifyContent="Start"
                        Wrap="Wrap" />
                </Border>

                <Label
                    FontFamily="Nasa21"
                    FontSize="12"
                    HorizontalOptions="Center"
                    IsVisible="{Binding IsVisualModeActive}"
                    Text="👆 Tap any chip to edit the variable name"
                    TextColor="{AppThemeBinding Light={StaticResource TextTertiaryLight},
                                                Dark={StaticResource TextTertiaryDark}}" />
            </VerticalStackLayout>

            <!--  Extra padding at bottom to ensure content is visible above keyboard  -->
            <BoxView HeightRequest="80" Color="Transparent" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>