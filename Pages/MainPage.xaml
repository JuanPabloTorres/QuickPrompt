<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceBackgroundLight}, Dark={StaticResource SurfaceBackgroundDark}}"
    Shell.PresentationMode="Animated">

    <Shell.TitleView>
        <Label
            FontFamily="Nasa21"
            FontSize="20"
            Text="Create Prompt"
            TextColor="{StaticResource PrimaryBlueDark}"
            VerticalOptions="Center" />
    </Shell.TitleView>

    <ContentPage.ToolbarItems>
        <!--  PRIMARY: Create Variable (most used)  -->
        <ToolbarItem Command="{Binding CreateVariableCommand}" IsEnabled="{Binding HasTextSelected}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="MaterialIconsOutlined-Regular" Glyph="&#xe146;" Color="{StaticResource PrimaryRed}" Size="24" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Create Variable</ToolTipProperties.Text>
        </ToolbarItem>

        <!--  PRIMARY: Save  -->
        <ToolbarItem Command="{Binding SavePromptCommand}" IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="MaterialIconsOutlined-Regular" Glyph="&#xe86c;" Color="{StaticResource PrimaryBlueDark}" Size="24" />
            </ToolbarItem.IconImageSource>
            <ToolTipProperties.Text>Save Prompt</ToolTipProperties.Text>
        </ToolbarItem>

        <!--  SECONDARY: Advanced Builder (in overflow menu)  -->
        <ToolbarItem 
            Text="Advanced Builder"
            Order="Secondary"
            Command="{Binding GoToAdvancedBuilderCommand}" 
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />

        <!--  SECONDARY: Import JSON (in overflow menu)  -->
        <ToolbarItem 
            Text="Import JSON"
            Order="Secondary"
            Command="{Binding ImportPromptCommand}" 
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />

        <!--  SECONDARY: Clear All (in overflow menu)  -->
        <ToolbarItem 
            Text="Clear All"
            Order="Secondary"
            Command="{Binding ClearTextCommand}" 
            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!--  Title  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Title" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12,0">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Grid HeightRequest="46">
                        <Entry
                            Text="{Binding PromptTitle, Mode=TwoWay}"
                            Placeholder="My awesome prompt..."
                            FontSize="15" FontFamily="Nasa21"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                            PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                            BackgroundColor="Transparent" VerticalOptions="Center" />
                    </Grid>
                </Border>
            </VerticalStackLayout>

            <!--  Description  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Description" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Editor
                        Placeholder="Optional description..."
                        Text="{Binding PromptDescription, Mode=TwoWay}"
                        FontSize="15" FontFamily="Nasa21"
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                        PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        BackgroundColor="Transparent"
                        AutoSize="TextChanges" 
                        MinimumHeightRequest="80" />
                </Border>
            </VerticalStackLayout>

            <!--  Category  -->
            <VerticalStackLayout Spacing="6">
                <Label 
                    Text="Category" 
                    FontSize="15" 
                    FontFamily="Nasa21" 
                    FontAttributes="Bold" 
                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="4,0">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <Picker
                        Title="Select category"
                        ItemsSource="{Binding Categories}"
                        SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                        FontSize="15" 
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                        TitleColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                        HeightRequest="46" VerticalOptions="Center" />
                </Border>
            </VerticalStackLayout>

            <!--  Prompt Template  -->
            <VerticalStackLayout Spacing="8">
                <Grid ColumnDefinitions="*,Auto">
                    <Label 
                        Text="Prompt Template" 
                        FontSize="15" 
                        FontFamily="Nasa21" 
                        FontAttributes="Bold" 
                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
                    <HorizontalStackLayout Grid.Column="1" Spacing="4">
                        <Border Padding="12,6" BackgroundColor="{StaticResource Gray100}" StrokeThickness="0">
                            <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SwitchToEditorCommand}" />
                            </Border.GestureRecognizers>
                            <Label Text="✏️ Text" FontSize="12" TextColor="{StaticResource PrimaryBlue}" />
                        </Border>
                        <Border Padding="12,6" BackgroundColor="{StaticResource PrimaryBlue}" StrokeThickness="0">
                            <Border.StrokeShape><RoundRectangle CornerRadius="16" /></Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SwitchToChipsCommand}" />
                            </Border.GestureRecognizers>
                            <Label Text="🎨 Visual" FontSize="12" TextColor="White" />
                        </Border>
                    </HorizontalStackLayout>
                </Grid>

                <!--  Instructions  -->
                <Border
                    BackgroundColor="{AppThemeBinding Light=#EFF6FF, Dark=#1E3A5F}"
                    Stroke="{AppThemeBinding Light=#BFDBFE, Dark=#3B82F6}"
                    StrokeThickness="1"
                    Padding="12"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    <VerticalStackLayout Spacing="6">
                        <Label 
                            Text="💡 How to create variables:" 
                            FontSize="13" 
                            FontAttributes="Bold" 
                            TextColor="{AppThemeBinding Light=#1D4ED8, Dark=#93C5FD}" />
                        <Label 
                            Text="• Select text → tap ➕ in toolbar" 
                            FontSize="12" 
                            TextColor="{AppThemeBinding Light=#2563EB, Dark=#BFDBFE}" />
                        <Label 
                            Text="• Or type directly: &lt;variable_name&gt;" 
                            FontSize="12" 
                            TextColor="{AppThemeBinding Light=#2563EB, Dark=#BFDBFE}" />
                    </VerticalStackLayout>
                </Border>

                <!--  Text Editor  -->
                <Border 
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1" 
                    Padding="12"
                    IsVisible="{Binding IsVisualModeActive, Converter={StaticResource InverseBoolConverter}}">
                    <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                    
                    <Grid>
                        <Editor
                            x:Name="PromptRawEditor"
                            Placeholder="Write your prompt here...&#x0a;&#x0a;Example: Create a &lt;format&gt; about &lt;topic&gt; for &lt;audience&gt;"
                            Text="{Binding PromptText, Mode=TwoWay}"
                            CursorPosition="{Binding CursorPosition, Mode=TwoWay}"
                            SelectionLength="{Binding SelectionLength, Mode=TwoWay}"
                            FontSize="15" FontFamily="Nasa21"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                            PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                            BackgroundColor="Transparent"
                            AutoSize="TextChanges"
                            MinimumHeightRequest="180"
                            Focused="OnEditorFocused"
                            Unfocused="OnEditorUnfocused" />
                        
                        <!--  ✨ Floating Variable Button  -->
                        <Border
                            x:Name="FloatingVariableButton"
                            IsVisible="False"
                            BackgroundColor="{StaticResource PrimaryBlue}"
                            Padding="12,6"
                            HorizontalOptions="Start"
                            VerticalOptions="Start"
                            Margin="10,5,0,0"
                            ZIndex="1000"
                            InputTransparent="False">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6" />
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow 
                                    Brush="{AppThemeBinding Light={StaticResource AppBlackLight}, Dark=#000000}" 
                                    Opacity="0.3" 
                                    Radius="8" 
                                    Offset="0,2" />
                            </Border.Shadow>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCreateVariableFromSelection" />
                            </Border.GestureRecognizers>
                            
                            <HorizontalStackLayout Spacing="6">
                                <Label
                                    FontFamily="MaterialIconsOutlined-Regular"
                                    Text="&#xe146;"
                                    FontSize="16"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <Label
                                    Text="Make Variable"
                                    FontFamily="Nasa21"
                                    FontSize="13"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  ✨ Floating Undo Variable Button  -->
                        <Border
                            x:Name="FloatingUndoVariableButton"
                            IsVisible="False"
                            BackgroundColor="{StaticResource PrimaryRed}"
                            Padding="12,6"
                            HorizontalOptions="Start"
                            VerticalOptions="Start"
                            Margin="10,5,0,0"
                            ZIndex="1000"
                            InputTransparent="False">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="6" />
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow 
                                    Brush="{AppThemeBinding Light={StaticResource AppBlackLight}, Dark=#000000}" 
                                    Opacity="0.3" 
                                    Radius="8" 
                                    Offset="0,2" />
                            </Border.Shadow>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnUndoVariableFromSelection" />
                            </Border.GestureRecognizers>
                            
                            <HorizontalStackLayout Spacing="6">
                                <Label
                                    FontFamily="MaterialIconsOutlined-Regular"
                                    Text="&#xe14c;"
                                    FontSize="16"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <Label
                                    Text="Remove Variable"
                                    FontFamily="Nasa21"
                                    FontSize="13"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>
                </Border>

                <!--  Visual Mode  -->
                <Border
                    IsVisible="{Binding IsVisualModeActive}"
                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                    Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                    StrokeThickness="1"
                    Padding="12" MinimumHeightRequest="120">
                    <Border.StrokeShape><RoundRectangle CornerRadius="12" /></Border.StrokeShape>
                    <FlexLayout
                        x:Name="PromptChipContainer"
                        Wrap="Wrap" Direction="Row"
                        AlignItems="Center" JustifyContent="Start" />
                </Border>

                <Label
                    Text="👆 Tap any chip to edit the variable name"
                    FontSize="12" FontFamily="Nasa21"
                    TextColor="{AppThemeBinding Light={StaticResource TextTertiaryLight}, Dark={StaticResource TextTertiaryDark}}"
                    HorizontalOptions="Center"
                    IsVisible="{Binding IsVisualModeActive}" />
            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>