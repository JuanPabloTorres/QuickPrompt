<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="QuickPrompt.Pages.PromptBuilderPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:QuickPrompt.Models"
    xmlns:views="clr-namespace:QuickPrompt.Views"
    x:Name="PageRef"
    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceBackgroundLight}, Dark={StaticResource SurfaceBackgroundDark}}"
    Shell.PresentationMode="Animated">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False" />
    </Shell.BackButtonBehavior>

    <Shell.TitleView>
        <views:TitleHeader
            Title="Prompt Builder"
            BackCommand="{Binding MyBackCommand}"
            ShowBackButton="True" />
    </Shell.TitleView>

    <ContentPage.ToolbarItems>
        <ToolbarItem Command="{Binding SavePromptCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="MaterialIconsOutlined-Regular" Glyph="&#xe86c;" Color="{StaticResource PrimaryBlueDark}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*,Auto,Auto" Padding="16">

        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Spacing="8" Margin="0,0,0,16">
            <Label 
                Text="Build Your Prompt" 
                FontSize="24" 
                FontFamily="Nasa21" 
                FontAttributes="Bold"
                TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                HorizontalTextAlignment="Center" />
            <Label 
                Text="Follow the steps to create a high-quality prompt"
                FontSize="14"
                FontFamily="Nasa21"
                TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                HorizontalTextAlignment="Center" />
        </VerticalStackLayout>

        <!-- CarouselView -->
        <CarouselView
            x:Name="PromptCarousel"
            Grid.Row="1"
            IndicatorView="{x:Reference PromptIndicator}"
            ItemsSource="{Binding Steps}"
            PositionChanged="OnCarouselPositionChanged">
            <CarouselView.ItemTemplate>
                <DataTemplate x:DataType="models:StepModel">
                    <Border 
                        Margin="8"
                        Padding="20"
                        BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceCardLight}, Dark={StaticResource SurfaceCardDark}}"
                        StrokeThickness="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="16" />
                        </Border.StrokeShape>
                        <Border.Shadow>
                            <Shadow 
                                Brush="{AppThemeBinding Light={StaticResource AppBlackLight}, Dark=#000000}" 
                                Opacity="0.1" 
                                Radius="10" 
                                Offset="0,4" />
                        </Border.Shadow>

                        <ScrollView>
                            <VerticalStackLayout Spacing="16">
                                <!-- Step Title -->
                                <Label 
                                    Text="{Binding Title}"
                                    FontSize="20"
                                    FontFamily="Nasa21"
                                    FontAttributes="Bold"
                                    TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                    HorizontalTextAlignment="Center" />

                                <!-- Preview Step -->
                                <VerticalStackLayout IsVisible="{Binding IsPreviewStep}" Spacing="12">
                                    <Label 
                                        Text="Review your prompt:" 
                                        FontSize="14" 
                                        TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Border 
                                        Padding="16" 
                                        BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                                        StrokeThickness="1" 
                                        Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}">
                                        <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                                        <Label 
                                            Text="{Binding PreviewContent}" 
                                            FontSize="14" 
                                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                                            LineBreakMode="WordWrap" />
                                    </Border>
                                </VerticalStackLayout>

                                <!-- Text Step -->
                                <VerticalStackLayout IsVisible="{Binding IsTextStep}" Spacing="8">
                                    <Border 
                                        Padding="12" 
                                        BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                                        Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                                        StrokeThickness="1">
                                        <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                                        <Editor
                                            Placeholder="{Binding Placeholder}"
                                            Text="{Binding InputText, Mode=TwoWay}"
                                            FontSize="15"
                                            FontFamily="Nasa21"
                                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                            PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                            BackgroundColor="Transparent"
                                            AutoSize="TextChanges"
                                            MinimumHeightRequest="120" />
                                    </Border>
                                </VerticalStackLayout>

                                <!-- Format Step -->
                                <VerticalStackLayout IsVisible="{Binding IsFormatStep}" Spacing="8">
                                    <Label 
                                        Text="Select format:" 
                                        FontSize="14" 
                                        FontFamily="Nasa21" 
                                        TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" 
                                        FontAttributes="Bold" />
                                    <Border 
                                        Padding="4" 
                                        BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceInputLight}, Dark={StaticResource SurfaceInputDark}}" 
                                        Stroke="{AppThemeBinding Light={StaticResource BorderDefaultLight}, Dark={StaticResource BorderDefaultDark}}" 
                                        StrokeThickness="1">
                                        <Border.StrokeShape><RoundRectangle CornerRadius="8" /></Border.StrokeShape>
                                        <Picker
                                            Title="{Binding Placeholder}"
                                            ItemsSource="{Binding AvailableFormats}"
                                            SelectedItem="{Binding SelectedOption, Mode=TwoWay}"
                                            FontSize="15"
                                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                            TitleColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    </Border>
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                        </ScrollView>
                    </Border>
                </DataTemplate>
            </CarouselView.ItemTemplate>
        </CarouselView>

        <!-- Indicator -->
        <IndicatorView
            x:Name="PromptIndicator"
            Grid.Row="2"
            Margin="0,8"
            HorizontalOptions="Center"
            IndicatorColor="{AppThemeBinding Light=#D1D5DB, Dark=#4B5563}"
            SelectedIndicatorColor="{StaticResource PrimaryBlue}"
            IndicatorSize="8" />

        <!-- Navigation Buttons -->
        <Grid Grid.Row="3" ColumnDefinitions="*,*" ColumnSpacing="12">
            <Button
                x:Name="BackButton"
                Grid.Column="0"
                Clicked="OnBackClicked"
                Text="â† Back"
                BackgroundColor="{AppThemeBinding Light=#E5E7EB, Dark=#374151}"
                TextColor="{AppThemeBinding Light=#374151, Dark=#E5E7EB}"
                FontFamily="Nasa21"
                CornerRadius="12"
                HeightRequest="48" />
            <Button
                x:Name="NextButton"
                Grid.Column="1"
                Clicked="OnNextClicked"
                Text="{Binding NextButtonText}"
                BackgroundColor="{StaticResource PrimaryBlue}"
                TextColor="White"
                FontFamily="Nasa21"
                CornerRadius="12"
                HeightRequest="48" />
        </Grid>
    </Grid>
</ContentPage>